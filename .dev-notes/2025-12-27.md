# 2025-12-27: Dependabot Auto-Merge with Safe CI/CD

## Problem

Enabling Dependabot auto-merge with auto-deployment posed risks:
1. `dependabot.yml` pointed to `/` but `package.json` is in `/frontend` - npm updates weren't being detected
2. Backend had no Python dependency monitoring
3. Backend deployed directly without any tests - risky with auto-merge
4. Each merge triggers production deployment (Vercel for frontend, HF Spaces for backend)

## Solution

### 1. Fixed Dependabot Configuration

Updated `.github/dependabot.yml`:
- Changed npm directory from `/` to `/frontend`
- Added `pip` ecosystem for `/backend` (Python dependencies)
- Kept GitHub Actions monitoring at `/`

### 2. Added Backend Testing Infrastructure

Created pytest setup for backend:
- `backend/tests/__init__.py`
- `backend/tests/conftest.py` - fixtures with mocked ML services
- `backend/tests/test_health.py` - tests for `/` and `/api/health` endpoints

Added to `backend/pyproject.toml`:
```toml
[dependency-groups]
dev = [
    "pyright>=1.1.407",
    "pytest>=8.0",
    "pytest-asyncio>=0.24",
    "httpx>=0.28",
]

[tool.pytest.ini_options]
asyncio_mode = "auto"
testpaths = ["tests"]
```

### 3. Updated Backend CI/CD Workflow

Modified `.github/workflows/deploy-backend.yml`:
- Added `test` job that runs before deploy
- Runs `uv run pyright` for type checking
- Runs `uv run pytest` for tests
- Deploy only happens after tests pass (`needs: test`)
- Added PR trigger for running tests on PRs

## How Auto-Merge Works Safely Now

1. **Dependabot** creates PRs for frontend (npm), backend (pip), and GitHub Actions
2. **CI runs tests** on every PR:
   - Frontend: `npm run test:coverage` (existing)
   - Backend: `pyright` + `pytest` (new)
3. **Auto-merge workflow** uses `gh pr merge --auto` which respects branch protection - only merges after ALL status checks pass
4. **Deploy** only triggers on push to main, after tests pass

## References

- [GitHub Docs: Automating Dependabot](https://docs.github.com/en/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions)
- [Best practices for auto-merge](https://lethain.com/dependabot-auto-merge/)

## Note on uv.lock

Dependabot updates `pyproject.toml` but won't update `uv.lock`. May need to add a workflow step to run `uv lock` after Dependabot PRs are merged.
