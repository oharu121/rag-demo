# Dev Notes - 2025-12-23

## Horizontal Mouse Wheel Scroll for DocumentChipsBar

### Problem
The `DocumentChipsBar` component has a horizontal scrollable area (`overflow-x-auto`) for document chips, but users couldn't scroll it using the mouse wheel. This is a common UX issue - users expect to scroll horizontally when hovering over a horizontal scrollable area.

### Solution
Added a `useEffect` hook that attaches a wheel event listener to convert vertical scroll (deltaY) into horizontal scroll (scrollLeft).

```tsx
const scrollContainerRef = useRef<HTMLDivElement>(null);

useEffect(() => {
  const container = scrollContainerRef.current;
  if (!container) return;

  const handleWheel = (e: WheelEvent) => {
    if (e.deltaY !== 0) {
      e.preventDefault();
      container.scrollLeft += e.deltaY;
    }
  };

  container.addEventListener("wheel", handleWheel, { passive: false });
  return () => container.removeEventListener("wheel", handleWheel);
}, [documents.length]); // Important: dependency on documents.length
```

### Key Implementation Details

1. **`passive: false`** - Required to call `e.preventDefault()`. Without this, the browser may ignore `preventDefault()` for performance reasons.

2. **`e.preventDefault()`** - Prevents the default vertical page scroll when hovering over the chips bar.

3. **Dependency array `[documents.length]`** - This was the critical fix! The component has an early return:
   ```tsx
   if (documents.length === 0) return null;
   ```

   When the component first mounts, documents might be empty (loading state), so the ref container is `null`. The `useEffect` with `[]` runs once on mount but finds no container. When documents load later, the component re-renders with the scroll container, but the `useEffect` doesn't run again.

   Adding `documents.length` to the dependency array ensures the effect re-runs after documents are loaded and the scroll container is rendered.

4. **Separate ref for scroll container** - The component uses `forwardRef` for the outer div (used by parent for other purposes), so we need a separate internal ref (`scrollContainerRef`) for the scrollable area.

### Structure
```tsx
<div ref={ref}> {/* forwardRef - outer container */}
  <div className="flex items-center gap-2">
    <span>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:</span> {/* Fixed label */}
    <div
      ref={scrollContainerRef}  {/* Scrollable container */}
      className="overflow-x-auto scrollbar-hide"
    >
      {/* chips */}
    </div>
  </div>
</div>
```

The label is outside the scrollable container so it stays fixed while chips scroll.

### Testing
You can verify the scroll is working by running this in browser console:
```javascript
const container = document.querySelector('.overflow-x-auto.scrollbar-hide');
const event = new WheelEvent('wheel', { deltaY: 100, bubbles: true, cancelable: true });
container.dispatchEvent(event);
console.log('Scrolled to:', container.scrollLeft); // Should be > 0
```

---

## Enhanced Evaluation Summary with Category Breakdown & Strategy Insights

### Problem
The original evaluation summary was a minimal bottom-anchored bar showing just `73% (11/15 æ­£è§£)` with a generic message. Users couldn't:
1. See which question categories the RAG was struggling with
2. Understand *why* a particular strategy performed well or poorly
3. Review past test results (bottom bar doesn't preserve history)

### Solution
Replaced the bottom-anchored bar with a rich message bubble that appears in the conversation flow after evaluation completes.

### Features

1. **Category-by-category breakdown** - Shows performance per question type:
   ```
   âœ… æš—é»™ã®ä¾‹å¤–      5/5  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   âŒ è¤‡æ•°ãƒ›ãƒƒãƒ—æ¨è«–   0/2  â–‘â–‘      â† è¦æ”¹å–„
   âœ… å¦å®šã®ç†è§£      2/2  â–ˆâ–ˆ
   ```

2. **Strategy-specific insights** - Explains *why* based on `.classmethod` analysis:
   ```
   ğŸ’¡ æ¨™æº–ãƒãƒ£ãƒ³ã‚¯ã§ã¯ã€ä¾‹å¤–è¦å®šãŒæœ¬æ–‡ã¨åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€
      è¤‡æ•°ãƒ›ãƒƒãƒ—æ¨è«–ã‚„æ¯”è¼ƒè¨ˆç®—ã§å¿…è¦ãªæƒ…å ±ãŒå–å¾—ã•ã‚Œã«ãã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚
   ```

3. **Message bubble format** - Results appear in conversation flow with Maya avatar, scrollable with history

### Implementation

#### 1. Shared Constants (`frontend/lib/constants.ts`)

```typescript
// Category display info (shared between MessageBubble and EvaluationSummaryBubble)
export const CATEGORY_DISPLAY_INFO: Record<string, { label: string; color: string; bgColor: string }> = {
  implicit_exception: {
    label: "æš—é»™ã®ä¾‹å¤–",
    color: "text-amber-700",
    bgColor: "bg-amber-100 border-amber-200",
  },
  multi_hop: {
    label: "è¤‡æ•°ãƒ›ãƒƒãƒ—æ¨è«–",
    color: "text-purple-700",
    bgColor: "bg-purple-100 border-purple-200",
  },
  // ... other categories
};

// Consistent ordering for display
export const CATEGORY_ORDER = [
  "implicit_exception",
  "multi_hop",
  "negation",
  "conditional",
  "not_in_documents",
  "cross_document",
] as const;

// Strategy insights keyed by {dataset}_{strategy}_{reranking}
export const STRATEGY_INSIGHTS: Record<string, string> = {
  original_standard_false:
    "æ¨™æº–ãƒãƒ£ãƒ³ã‚¯ã§ã¯ã€ä¾‹å¤–è¦å®šãŒæœ¬æ–‡ã¨åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚...",
  original_large_false:
    "å¤§ããªãƒãƒ£ãƒ³ã‚¯ã«ã‚ˆã‚Šã€ä¸€èˆ¬è¦å‰‡ã¨ä¾‹å¤–ãŒåŒä¸€ãƒãƒ£ãƒ³ã‚¯å†…ã«ä¿æŒã•ã‚Œ...",
  // ... other tested configurations
};

export function getStrategyInsightKey(
  documentSet: string,
  strategy: string,
  useReranking: boolean
): string {
  return `${documentSet}_${strategy}_${useReranking}`;
}
```

#### 2. Category Score Computation (`frontend/app/components/ChatInterface.tsx`)

```typescript
// Compute category scores from evaluation messages
const categoryScores = useMemo(() => {
  const scores: Record<string, { correct: number; total: number }> = {};

  // Iterate through message pairs (user question + assistant answer)
  for (let i = 0; i < messages.length; i += 2) {
    const userMsg = messages[i];
    const assistantMsg = messages[i + 1];

    if (userMsg?.category && assistantMsg?.scoring) {
      const cat = userMsg.category;
      if (!scores[cat]) scores[cat] = { correct: 0, total: 0 };
      scores[cat].total++;
      if (assistantMsg.scoring.isCorrect) scores[cat].correct++;
    }
  }

  return scores;
}, [messages]);
```

#### 3. New Summary Bubble Component (`frontend/app/components/EvaluationSummaryBubble.tsx`)

Key features:
- Maya avatar on left (consistent with assistant messages)
- Configuration badges (dataset, strategy, reranking)
- Overall score with progress bar
- Category breakdown table with mini progress bars
- Strategy insight from lookup table (or generic fallback)

```tsx
// Render in ChatInterface after messages
{evaluationScore && !isEvaluating && (
  <div className="animate-fade-in-up mt-6">
    <EvaluationSummaryBubble
      score={evaluationScore}
      categoryScores={categoryScores}
      documentSet={documentSet}
      strategy={strategy}
      useReranking={useReranking}
    />
  </div>
)}
```

### Files Changed

| File | Change |
|------|--------|
| `frontend/lib/constants.ts` | Added `CATEGORY_DISPLAY_INFO`, `CATEGORY_ORDER`, `STRATEGY_INSIGHTS`, `getStrategyInsightKey()` |
| `frontend/app/components/EvaluationSummaryBubble.tsx` | **NEW** - Rich summary component |
| `frontend/app/components/ChatInterface.tsx` | Added `categoryScores` useMemo, render new bubble |
| `frontend/app/components/MessageBubble.tsx` | Import shared `CATEGORY_DISPLAY_INFO` instead of local constant |
| `frontend/app/components/EvaluationSummary.tsx` | **DELETED** - Replaced by new bubble |

### Strategy Insights Source

Insights are derived from manual analysis in `.classmethod/` folder:
- `simple-chunk-results-analysis.md`
- `large-chunk-results-analysis.md`
- `standard-reranked-results-analysis.md`
- `parent-child-results-analysis.md`
- `parent-child-reranked-results-analysis.md`
- `optimized-standard-results-analysis.md`
- `hypothetical-questions-results-analysis.md`

Only tested configurations have insights. Untested combinations show a generic fallback message.

---

## Fix: Evaluation Progress Display Showing "0/10" Before Actual Total

### Problem
When clicking the "ç²¾åº¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ" button, the progress display briefly showed "0/10" before correcting to "0/15" once the first `query_start` event arrived from the server. This caused a confusing visual jump.

### Root Cause
In `ChatInterface.tsx`, the evaluation progress was initialized with a hardcoded total of 10:
```typescript
setEvaluationProgress({ current: 0, total: 10 }); // âŒ Wrong - hardcoded value
```

The actual total (15) only arrives with the first `query_start` SSE event from the backend.

### Solution
Two changes were made:

#### 1. Initialize with `total: 0` (`ChatInterface.tsx`)
```typescript
// Before
setEvaluationProgress({ current: 0, total: 10 });

// After
setEvaluationProgress({ current: 0, total: 0 }); // Will update on first query_start event
```

#### 2. Show "æº–å‚™ä¸­..." when total is unknown (`DatasetSelector.tsx`)
Updated the progress display in both collapsed and expanded views:

```tsx
// Before - always showed current/total
<span>{evaluationProgress.current}/{evaluationProgress.total}</span>

// After - show "æº–å‚™ä¸­..." until we know the total
<span>
  {evaluationProgress.total > 0
    ? `${evaluationProgress.current}/${evaluationProgress.total}`
    : "æº–å‚™ä¸­..."}
</span>
```

### User Experience
- **Before**: "0/10" â†’ (flicker) â†’ "0/15" â†’ "1/15" â†’ ...
- **After**: "æº–å‚™ä¸­..." â†’ "1/15" â†’ "2/15" â†’ ...

The evaluation starts cleanly with a loading state until the actual total is known.

### Files Changed
| File | Change |
|------|--------|
| `frontend/app/components/ChatInterface.tsx` | Changed `total: 10` to `total: 0` on line 100 |
| `frontend/app/components/DatasetSelector.tsx` | Added conditional display for progress in both collapsed (line ~168) and expanded (line ~279) views |

---

## Basic Markdown Rendering in MessageBubble

### Problem
Assistant messages were displaying raw markdown syntax instead of rendered formatting:
- Citations like `[ç¦åˆ©åšç”Ÿè¦ç¨‹.md:119]` (single line number) were not styled in blue - only range format `[file:10-20]` worked
- Bullet points `* item` displayed as plain text with asterisks
- Bold text `**text**` displayed with literal asterisks

### Solution
Integrated `react-markdown` for basic markdown rendering while preserving custom citation styling.

### Implementation

#### 1. Install react-markdown
```bash
npm install react-markdown
```

Added to `frontend/package.json`:
```json
"dependencies": {
  "react-markdown": "^10.1.0"
}
```

#### 2. Update MessageBubble.tsx

Replaced `renderContentWithCitations()` with `renderContentWithMarkdown()`:

```typescript
import Markdown from "react-markdown";
import type { Components } from "react-markdown";

// Custom markdown components for styling
const markdownComponents: Components = {
  // Unwrap paragraphs to preserve inline flow with whitespace-pre-wrap
  p: ({ children }) => <>{children}</>,
  // Style bold text
  strong: ({ children }) => <strong className="font-semibold">{children}</strong>,
  // Style lists with proper indentation
  ul: ({ children }) => <ul className="list-disc list-inside my-1 space-y-0.5">{children}</ul>,
  ol: ({ children }) => <ol className="list-decimal list-inside my-1 space-y-0.5">{children}</ol>,
  li: ({ children }) => <li className="ml-1">{children}</li>,
  // Disable links (we handle citations separately)
  a: ({ children }) => <>{children}</>,
  // Disable headings (not needed in chat context)
  h1: ({ children }) => <strong className="font-semibold">{children}</strong>,
  h2: ({ children }) => <strong className="font-semibold">{children}</strong>,
  h3: ({ children }) => <strong className="font-semibold">{children}</strong>,
  // Code styling
  code: ({ children }) => (
    <code className="bg-gray-100 px-1 py-0.5 rounded text-sm font-mono">{children}</code>
  ),
};

function renderContentWithMarkdown(content: string): React.ReactNode {
  // Match any bracketed text that looks like a citation
  const citationRegex = /(\[[^\]\s]+\])/g;
  const parts = content.split(citationRegex);

  return parts.map((part, index) => {
    // Check if this part looks like a citation (has brackets and contains a colon with numbers)
    if (part.match(/^\[[^\]]+:\d+(-\d+)?\]$/)) {
      return (
        <span key={index} className="text-blue-600 font-medium">
          {part}
        </span>
      );
    }
    // Render non-citation parts through markdown
    return (
      <Markdown key={index} components={markdownComponents}>
        {part}
      </Markdown>
    );
  });
}
```

### Key Design Decisions

1. **Two-phase rendering**: Split content by citations first, then render non-citation parts through markdown. This ensures citations are styled with blue color regardless of markdown parsing.

2. **Improved citation regex**: Changed from `/(\[[^\]:\s]+:\d+-\d+\])/g` (only ranges) to `/^\[[^\]]+:\d+(-\d+)?\]$/` which matches both:
   - `[file.md:119]` (single line)
   - `[file.md:10-20]` (range)

3. **Unwrap paragraphs**: Set `p: ({ children }) => <>{children}</>` to prevent markdown from wrapping content in `<p>` tags, which would break the `whitespace-pre-wrap` layout.

4. **Disabled features**: Links (`a`), and headings are either disabled or converted to simpler elements to keep the chat UI clean.

### Supported Markdown Features

| Syntax | Renders As |
|--------|------------|
| `**bold**` | **bold** |
| `* item` | â€¢ bullet point |
| `1. item` | numbered list |
| `` `code` `` | inline code |
| `[file.md:10]` | blue citation |
| `[file.md:10-20]` | blue citation |

### Files Changed

| File | Change |
|------|--------|
| `frontend/package.json` | Added `react-markdown: ^10.1.0` dependency |
| `frontend/app/components/MessageBubble.tsx` | Replaced `renderContentWithCitations` with markdown-aware `renderContentWithMarkdown` |

### Result

- Citations now render in blue for both single-line and range formats
- Bullet points render as proper `<ul>/<li>` elements with disc markers
- Bold text renders with proper `<strong>` tags
- Line breaks and whitespace are preserved

---

## Citation Format Standardization & Markdown Improvements

### Problem

After initial markdown implementation, several issues remained:
1. Citations with Japanese format `[å‡ºå…¸: ç¦åˆ©åšç”Ÿè¦ç¨‹.md, 154-156è¡Œç›®]` weren't styled blue
2. No bold text appearing in responses (LLM wasn't using `**text**` syntax)
3. Spacing issues: bullet points too spread out, paragraphs too close

### Root Cause Analysis

**Backend Citation Format Mismatch** in `backend/app/services/rag_service.py`:

1. Context headers used: `[å‡ºå…¸: {filename}, {start_line}-{end_line}è¡Œç›®]`
2. Prompt instructed LLM to use: `[ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·]`

The LLM saw one format in context but was told to output another, causing inconsistent citation formats.

### Solution: Two-Part Fix

#### Part 1: Backend Changes (`rag_service.py`)

1. **Standardized citation format** in `format_docs_with_citations()`:
   ```python
   # FROM:
   header = f"[å‡ºå…¸: {filename}, {start_line}-{end_line}è¡Œç›®]"
   # TO:
   header = f"[{filename}:{start_line}-{end_line}]"
   ```

2. **Updated prompt templates** to explicitly request markdown formatting:
   ```python
   template = """ã‚ãªãŸã¯è¦ªåˆ‡ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ã„ã¦è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

   ## å¼•ç”¨å½¢å¼
   å„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã¯[ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·]å½¢å¼ã®å‡ºå…¸ãŒä»˜ã„ã¦ã„ã¾ã™ã€‚
   å›ç­”ã§æƒ…å ±ã‚’å¼•ç”¨ã™ã‚‹éš›ã¯ã€åŒã˜å½¢å¼ã§å¼•ç”¨ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š[è¦ç¨‹.md:10-20]ï¼‰ã€‚

   ## å›ç­”å½¢å¼
   - é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã¯**å¤ªå­—**ã§å¼·èª¿ã—ã¦ãã ã•ã„
   - è¤‡æ•°ã®é …ç›®ãŒã‚ã‚‹å ´åˆã¯ç®‡æ¡æ›¸ãï¼ˆ* ã¾ãŸã¯ -ï¼‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
   - æ®µè½é–“ã¯ç©ºè¡Œã‚’å…¥ã‚Œã¦ãã ã•ã„
   ...
   """
   ```

#### Part 2: Frontend Changes (`MessageBubble.tsx`)

1. **Added `isCitation()` helper** to handle multiple citation formats:
   ```typescript
   function isCitation(text: string): boolean {
     // Standard format: [file.md:10] or [file.md:10-20]
     if (/^\[[^\]]+:\d+(-\d+)?\]$/.test(text)) return true;
     // Japanese format: [å‡ºå…¸: file, X-Yè¡Œç›®]
     if (/^\[å‡ºå…¸:.+\d+.*è¡Œç›®\]$/.test(text)) return true;
     return false;
   }
   ```

2. **Updated markdownComponents** for better spacing:
   ```typescript
   const markdownComponents: Components = {
     // Add paragraph spacing (was: no margin)
     p: ({ children }) => <span className="block mb-3">{children}</span>,
     // Tighter list spacing (was: space-y-0.5)
     ul: ({ children }) => <ul className="list-disc list-inside my-2 space-y-1">{children}</ul>,
     ol: ({ children }) => <ol className="list-decimal list-inside my-2 space-y-1">{children}</ol>,
     li: ({ children }) => <li>{children}</li>,
     // ... rest unchanged
   };
   ```

### Files Changed

| File | Change |
|------|--------|
| `backend/app/services/rag_service.py` | 1. Updated `format_docs_with_citations()` to use `[filename:start-end]` format (line 99)<br>2. Updated both prompt templates to include markdown formatting instructions |
| `frontend/app/components/MessageBubble.tsx` | 1. Added `isCitation()` helper function<br>2. Updated citation regex to match any `[...]`<br>3. Adjusted paragraph and list spacing |

### Industry Best Practices Applied

**Backend (LLM Output Formatting)**:
- Explicit format instructions in system prompt
- Consistent citation format between context and expected output
- Markdown formatting guidance for structured responses

**Frontend (Markdown Rendering)**:
- react-markdown for robust parsing
- Custom components for controlled styling
- Pre-process citations before markdown parsing

### Expected Results

- `[ç¦åˆ©åšç”Ÿè¦ç¨‹.md:154-156]` â†’ blue citation (consistent format from backend)
- `**é‡è¦:**` â†’ **é‡è¦:** (bold text, prompted by backend)
- Better paragraph spacing (`mb-3`), tighter bullet points (`space-y-1`)
