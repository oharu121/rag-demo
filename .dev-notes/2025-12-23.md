# Dev Notes - 2025-12-23

## Horizontal Mouse Wheel Scroll for DocumentChipsBar

### Problem
The `DocumentChipsBar` component has a horizontal scrollable area (`overflow-x-auto`) for document chips, but users couldn't scroll it using the mouse wheel. This is a common UX issue - users expect to scroll horizontally when hovering over a horizontal scrollable area.

### Solution
Added a `useEffect` hook that attaches a wheel event listener to convert vertical scroll (deltaY) into horizontal scroll (scrollLeft).

```tsx
const scrollContainerRef = useRef<HTMLDivElement>(null);

useEffect(() => {
  const container = scrollContainerRef.current;
  if (!container) return;

  const handleWheel = (e: WheelEvent) => {
    if (e.deltaY !== 0) {
      e.preventDefault();
      container.scrollLeft += e.deltaY;
    }
  };

  container.addEventListener("wheel", handleWheel, { passive: false });
  return () => container.removeEventListener("wheel", handleWheel);
}, [documents.length]); // Important: dependency on documents.length
```

### Key Implementation Details

1. **`passive: false`** - Required to call `e.preventDefault()`. Without this, the browser may ignore `preventDefault()` for performance reasons.

2. **`e.preventDefault()`** - Prevents the default vertical page scroll when hovering over the chips bar.

3. **Dependency array `[documents.length]`** - This was the critical fix! The component has an early return:
   ```tsx
   if (documents.length === 0) return null;
   ```

   When the component first mounts, documents might be empty (loading state), so the ref container is `null`. The `useEffect` with `[]` runs once on mount but finds no container. When documents load later, the component re-renders with the scroll container, but the `useEffect` doesn't run again.

   Adding `documents.length` to the dependency array ensures the effect re-runs after documents are loaded and the scroll container is rendered.

4. **Separate ref for scroll container** - The component uses `forwardRef` for the outer div (used by parent for other purposes), so we need a separate internal ref (`scrollContainerRef`) for the scrollable area.

### Structure
```tsx
<div ref={ref}> {/* forwardRef - outer container */}
  <div className="flex items-center gap-2">
    <span>ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:</span> {/* Fixed label */}
    <div
      ref={scrollContainerRef}  {/* Scrollable container */}
      className="overflow-x-auto scrollbar-hide"
    >
      {/* chips */}
    </div>
  </div>
</div>
```

The label is outside the scrollable container so it stays fixed while chips scroll.

### Testing
You can verify the scroll is working by running this in browser console:
```javascript
const container = document.querySelector('.overflow-x-auto.scrollbar-hide');
const event = new WheelEvent('wheel', { deltaY: 100, bubbles: true, cancelable: true });
container.dispatchEvent(event);
console.log('Scrolled to:', container.scrollLeft); // Should be > 0
```

---

## Enhanced Evaluation Summary with Category Breakdown & Strategy Insights

### Problem
The original evaluation summary was a minimal bottom-anchored bar showing just `73% (11/15 æ­£è§£)` with a generic message. Users couldn't:
1. See which question categories the RAG was struggling with
2. Understand *why* a particular strategy performed well or poorly
3. Review past test results (bottom bar doesn't preserve history)

### Solution
Replaced the bottom-anchored bar with a rich message bubble that appears in the conversation flow after evaluation completes.

### Features

1. **Category-by-category breakdown** - Shows performance per question type:
   ```
   âœ… æš—é»™ã®ä¾‹å¤–      5/5  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
   âŒ è¤‡æ•°ãƒ›ãƒƒãƒ—æ¨è«–   0/2  â–‘â–‘      â† è¦æ”¹å–„
   âœ… å¦å®šã®ç†è§£      2/2  â–ˆâ–ˆ
   ```

2. **Strategy-specific insights** - Explains *why* based on `.classmethod` analysis:
   ```
   ğŸ’¡ æ¨™æº–ãƒãƒ£ãƒ³ã‚¯ã§ã¯ã€ä¾‹å¤–è¦å®šãŒæœ¬æ–‡ã¨åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€
      è¤‡æ•°ãƒ›ãƒƒãƒ—æ¨è«–ã‚„æ¯”è¼ƒè¨ˆç®—ã§å¿…è¦ãªæƒ…å ±ãŒå–å¾—ã•ã‚Œã«ãã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚
   ```

3. **Message bubble format** - Results appear in conversation flow with Maya avatar, scrollable with history

### Implementation

#### 1. Shared Constants (`frontend/lib/constants.ts`)

```typescript
// Category display info (shared between MessageBubble and EvaluationSummaryBubble)
export const CATEGORY_DISPLAY_INFO: Record<string, { label: string; color: string; bgColor: string }> = {
  implicit_exception: {
    label: "æš—é»™ã®ä¾‹å¤–",
    color: "text-amber-700",
    bgColor: "bg-amber-100 border-amber-200",
  },
  multi_hop: {
    label: "è¤‡æ•°ãƒ›ãƒƒãƒ—æ¨è«–",
    color: "text-purple-700",
    bgColor: "bg-purple-100 border-purple-200",
  },
  // ... other categories
};

// Consistent ordering for display
export const CATEGORY_ORDER = [
  "implicit_exception",
  "multi_hop",
  "negation",
  "conditional",
  "not_in_documents",
  "cross_document",
] as const;

// Strategy insights keyed by {dataset}_{strategy}_{reranking}
export const STRATEGY_INSIGHTS: Record<string, string> = {
  original_standard_false:
    "æ¨™æº–ãƒãƒ£ãƒ³ã‚¯ã§ã¯ã€ä¾‹å¤–è¦å®šãŒæœ¬æ–‡ã¨åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ãŸã‚...",
  original_large_false:
    "å¤§ããªãƒãƒ£ãƒ³ã‚¯ã«ã‚ˆã‚Šã€ä¸€èˆ¬è¦å‰‡ã¨ä¾‹å¤–ãŒåŒä¸€ãƒãƒ£ãƒ³ã‚¯å†…ã«ä¿æŒã•ã‚Œ...",
  // ... other tested configurations
};

export function getStrategyInsightKey(
  documentSet: string,
  strategy: string,
  useReranking: boolean
): string {
  return `${documentSet}_${strategy}_${useReranking}`;
}
```

#### 2. Category Score Computation (`frontend/app/components/ChatInterface.tsx`)

```typescript
// Compute category scores from evaluation messages
const categoryScores = useMemo(() => {
  const scores: Record<string, { correct: number; total: number }> = {};

  // Iterate through message pairs (user question + assistant answer)
  for (let i = 0; i < messages.length; i += 2) {
    const userMsg = messages[i];
    const assistantMsg = messages[i + 1];

    if (userMsg?.category && assistantMsg?.scoring) {
      const cat = userMsg.category;
      if (!scores[cat]) scores[cat] = { correct: 0, total: 0 };
      scores[cat].total++;
      if (assistantMsg.scoring.isCorrect) scores[cat].correct++;
    }
  }

  return scores;
}, [messages]);
```

#### 3. New Summary Bubble Component (`frontend/app/components/EvaluationSummaryBubble.tsx`)

Key features:
- Maya avatar on left (consistent with assistant messages)
- Configuration badges (dataset, strategy, reranking)
- Overall score with progress bar
- Category breakdown table with mini progress bars
- Strategy insight from lookup table (or generic fallback)

```tsx
// Render in ChatInterface after messages
{evaluationScore && !isEvaluating && (
  <div className="animate-fade-in-up mt-6">
    <EvaluationSummaryBubble
      score={evaluationScore}
      categoryScores={categoryScores}
      documentSet={documentSet}
      strategy={strategy}
      useReranking={useReranking}
    />
  </div>
)}
```

### Files Changed

| File | Change |
|------|--------|
| `frontend/lib/constants.ts` | Added `CATEGORY_DISPLAY_INFO`, `CATEGORY_ORDER`, `STRATEGY_INSIGHTS`, `getStrategyInsightKey()` |
| `frontend/app/components/EvaluationSummaryBubble.tsx` | **NEW** - Rich summary component |
| `frontend/app/components/ChatInterface.tsx` | Added `categoryScores` useMemo, render new bubble |
| `frontend/app/components/MessageBubble.tsx` | Import shared `CATEGORY_DISPLAY_INFO` instead of local constant |
| `frontend/app/components/EvaluationSummary.tsx` | **DELETED** - Replaced by new bubble |

### Strategy Insights Source

Insights are derived from manual analysis in `.classmethod/` folder:
- `simple-chunk-results-analysis.md`
- `large-chunk-results-analysis.md`
- `standard-reranked-results-analysis.md`
- `parent-child-results-analysis.md`
- `parent-child-reranked-results-analysis.md`
- `optimized-standard-results-analysis.md`
- `hypothetical-questions-results-analysis.md`

Only tested configurations have insights. Untested combinations show a generic fallback message.
